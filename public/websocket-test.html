<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - DomainFlow</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background: #28a745; }
        .disconnected { background: #dc3545; }
        .connecting { background: #ffc107; color: #000; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #messages { background: #2d3748; padding: 15px; border-radius: 4px; height: 400px; overflow-y: auto; font-family: monospace; }
        .message { margin: 5px 0; padding: 5px; border-left: 3px solid #007bff; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        input { padding: 8px; margin: 5px; background: #2d3748; color: #fff; border: 1px solid #4a5568; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— WebSocket Integration Test</h1>
        <p>Test the real-time WebSocket connection for DomainFlow campaign streaming</p>
        
        <div id="status" class="status disconnected">
            âŒ Disconnected
        </div>
        
        <div style="margin: 20px 0;">
            <button id="connectBtn" onclick="connectWebSocket()">Connect WebSocket</button>
            <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>Disconnect</button>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>
        
        <div style="margin: 20px 0;">
            <h3>ğŸ§ª Test Message Broadcasting</h3>
            <button onclick="testBroadcast()">Send Test Broadcast</button>
            <br><br>
            <input type="text" id="campaignId" placeholder="Campaign ID (e.g., test-campaign-123)" value="test-campaign-123">
            <select id="messageType">
                <option value="domain_generated">Domain Generated</option>
                <option value="campaign_progress">Campaign Progress</option>
                <option value="dns_validation">DNS Validation</option>
            </select>
            <button onclick="testCampaignMessage()">Send Campaign Message</button>
        </div>
        
        <div style="margin: 20px 0;">
            <h3>ğŸ“¥ Messages</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let messageCount = 0;

        function updateStatus(status, message) {
            const statusEl = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            statusEl.className = `status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusEl.innerHTML = 'âœ… Connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    break;
                case 'connecting':
                    statusEl.innerHTML = 'ğŸ”„ Connecting...';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = true;
                    break;
                case 'disconnected':
                    statusEl.innerHTML = 'âŒ Disconnected';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    break;
            }
            
            if (message) {
                addMessage('info', message);
            }
        }

        function addMessage(type, message) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            messageCount++;
        }

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('error', 'WebSocket is already connected');
                return;
            }

            updateStatus('connecting', 'Attempting to connect to WebSocket...');
            
            // Note: In a real implementation, this would need authentication
            // For testing, we'll connect to the endpoint directly
            const wsUrl = 'ws://localhost:8080/api/v2/ws';
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    updateStatus('connected', 'WebSocket connected successfully!');
                    
                    // Send connection initialization
                    ws.send(JSON.stringify({
                        type: 'connection_init',
                        lastSequenceNumber: 0
                    }));
                    
                    // Subscribe to a test campaign
                    ws.send(JSON.stringify({
                        type: 'subscribe_campaign',
                        campaignId: 'test-campaign-123',
                        lastSequenceNumber: 0
                    }));
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessage('success', `ğŸ“¥ Received: ${data.type || 'unknown'} - ${JSON.stringify(data, null, 2)}`);
                    } catch (e) {
                        addMessage('success', `ğŸ“¥ Received (raw): ${event.data}`);
                    }
                };
                
                ws.onerror = function(error) {
                    addMessage('error', `âŒ WebSocket error: ${error.message || 'Connection failed'}`);
                    updateStatus('disconnected');
                };
                
                ws.onclose = function(event) {
                    addMessage('info', `ğŸ”Œ WebSocket closed: Code ${event.code}, Reason: ${event.reason || 'No reason provided'}`);
                    updateStatus('disconnected');
                };
                
            } catch (error) {
                addMessage('error', `âŒ Failed to create WebSocket: ${error.message}`);
                updateStatus('disconnected');
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close(1000, 'User initiated disconnect');
                ws = null;
            }
        }

        function testBroadcast() {
            fetch('http://localhost:8080/api/v2/broadcast-test')
                .then(response => response.json())
                .then(data => {
                    addMessage('info', `ğŸ“¤ Test broadcast sent: ${data.message}`);
                })
                .catch(error => {
                    addMessage('error', `âŒ Failed to send test broadcast: ${error.message}`);
                });
        }

        function testCampaignMessage() {
            const campaignId = document.getElementById('campaignId').value;
            const messageType = document.getElementById('messageType').value;
            
            if (!campaignId) {
                addMessage('error', 'âŒ Please enter a campaign ID');
                return;
            }
            
            const url = `http://localhost:8080/api/v2/test-campaign-ws/${encodeURIComponent(campaignId)}?type=${messageType}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    addMessage('info', `ğŸ“¤ Campaign message sent: ${data.message} (ID: ${data.messageId})`);
                })
                .catch(error => {
                    addMessage('error', `âŒ Failed to send campaign message: ${error.message}`);
                });
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            messageCount = 0;
        }

        // Auto-connect on page load for convenience
        window.addEventListener('load', function() {
            addMessage('info', 'ğŸš€ WebSocket Test Page Loaded');
            addMessage('info', 'ğŸ’¡ Click "Connect WebSocket" to start testing');
        });
    </script>
</body>
</html>