name: Frontend Extended Suites

on:
  workflow_dispatch:
    inputs:
      suites:
        description: 'Comma-separated list of suites to run (accessibility,visual,cross-browser,performance)'
        required: false
        default: 'all'
  schedule:
    - cron: '0 5 * * *'
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'components/**'
      - 'playwright.config.ts'
      - 'lighthouserc.*'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [ main ]
    types: [opened, reopened, labeled, synchronize]
    paths:
      - 'src/**'
      - 'components/**'
      - 'playwright.config.ts'
      - 'lighthouserc.*'
      - 'package.json'
      - 'package-lock.json'

env:
  PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
  LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

jobs:
  accessibility-test:
    name: Accessibility
    runs-on: ubuntu-latest
    if: >-
      ${{ (github.event_name != 'pull_request' ||
           (contains(github.event.pull_request.labels.*.name, 'run-ui-suite') && !github.event.pull_request.head.repo.fork)) &&
          (github.event_name != 'workflow_dispatch' || contains(inputs.suites, 'accessibility') || inputs.suites == 'all') }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run accessibility tests
        run: npm run test:accessibility

      - name: Upload accessibility report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: accessibility-report
          path: playwright-report/

  visual-regression:
    name: Visual Regression
    runs-on: ubuntu-latest
    if: >-
      ${{ env.PERCY_TOKEN != '' &&
          (github.event_name != 'pull_request' ||
           (contains(github.event.pull_request.labels.*.name, 'run-ui-suite') && !github.event.pull_request.head.repo.fork)) &&
          (github.event_name != 'workflow_dispatch' || contains(inputs.suites, 'visual') || inputs.suites == 'all') }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run visual regression tests
        env:
          PERCY_TOKEN: ${{ env.PERCY_TOKEN }}
        run: npm run test:visual

  cross-browser:
    name: Cross-Browser
    runs-on: ubuntu-latest
    if: >-
      ${{ (github.event_name != 'pull_request' ||
          (contains(github.event.pull_request.labels.*.name, 'run-ui-suite') && !github.event.pull_request.head.repo.fork)) &&
          (github.event_name != 'workflow_dispatch' || contains(inputs.suites, 'cross-browser') || inputs.suites == 'all') }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run cross-browser tests
        run: npm run test:e2e

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cross-browser-report
          path: playwright-report/

  performance-audit:
    name: Performance Audit
    runs-on: ubuntu-latest
    if: >-
      ${{ env.LHCI_GITHUB_APP_TOKEN != '' &&
          (github.event_name != 'pull_request' ||
           (contains(github.event.pull_request.labels.*.name, 'run-ui-suite') && !github.event.pull_request.head.repo.fork)) &&
          (github.event_name != 'workflow_dispatch' || contains(inputs.suites, 'performance') || inputs.suites == 'all') }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Lighthouse CI
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ env.LHCI_GITHUB_APP_TOKEN }}
        run: npm run lighthouse

      - name: Run performance tests
        run: npm run test:performance
