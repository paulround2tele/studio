# N+1 Optimization Configuration
# This file controls all optimization features implemented across phases 1-4

optimization:
  enabled: true
  
  # Control which optimization phases are enabled
  phases:
    batch_queries: true         # Phase 1: Database batch query methods
    service_optimization: true  # Phase 2: Service layer N+1 pattern elimination
    external_validation: true   # Phase 3: External validation call optimization
    caching: true              # Phase 4: Redis caching layer
  
  # Redis cache configuration
  redis:
    enabled: true
    addr: "localhost:6379"
    password: ""
    db: 0
    pool_size: 20
    min_idle_conns: 5
    idle_timeout: "300s"
    dial_timeout: "5s"
    read_timeout: "3s"
    write_timeout: "3s"
    max_retries: 3
    
    # Entity TTL settings
    entity_ttl:
      persona_ttl: "5m"
      keyword_set_ttl: "10m"
      keyword_ttl: "15m"
      proxy_ttl: "5m"
    
    # Validation result TTLs
    validation_ttl:
      dns_validation_ttl: "2m"
      http_validation_ttl: "1m"
      config_fingerprint_ttl: "30m"
    
    # Campaign data TTLs
    campaign_ttl:
      campaign_details_ttl: "3m"
      campaign_relationship_ttl: "5m"
      batch_query_result_ttl: "2m"
    
    # Metrics configuration
    metrics:
      enabled: true
      flush_interval: "30s"
      performance_threshold:
        latency_warning_ms: 50
        latency_critical_ms: 100
        hit_ratio_warning: 0.7
        error_rate_warning: 0.05
  
  # Performance tuning parameters
  performance:
    batch_size: 100
    max_concurrent_requests: 50
    dns_timeout: "10s"
    http_timeout: "30s"
    
    # Cache TTL overrides for optimization
    cache_ttl:
      personas: "5m"
      keyword_sets: "10m"
      keywords: "15m"
      proxies: "5m"
      dns_validation: "2m"
      http_validation: "1m"

  # Feature flags for gradual rollout and testing
  feature_flags:
    gradual_rollout: false
    rollout_percentage: 100
    fallback_on_error: true
    debug_logging: false

---
# Environment-specific configurations

# Development environment
development:
  optimization:
    enabled: true
    phases:
      batch_queries: true
      service_optimization: true
      external_validation: true
      caching: true
    redis:
      enabled: true
      addr: "localhost:6379"
    performance:
      batch_size: 50  # Smaller batches for development
    feature_flags:
      debug_logging: true
      fallback_on_error: true

# Staging environment
staging:
  optimization:
    enabled: true
    phases:
      batch_queries: true
      service_optimization: true
      external_validation: true
      caching: true
    redis:
      enabled: true
      addr: "${REDIS_ADDR:localhost:6379}"
      password: "${REDIS_PASSWORD:}"
    feature_flags:
      gradual_rollout: true
      rollout_percentage: 50
      debug_logging: false
      fallback_on_error: true

# Production environment
production:
  optimization:
    enabled: true
    phases:
      batch_queries: true
      service_optimization: true
      external_validation: true
      caching: true
    redis:
      enabled: true
      addr: "${REDIS_ADDR}"
      password: "${REDIS_PASSWORD}"
      db: "${REDIS_DB:0}"
      pool_size: "${REDIS_POOL_SIZE:50}"
    performance:
      batch_size: "${OPTIMIZATION_BATCH_SIZE:100}"
      max_concurrent_requests: "${OPTIMIZATION_MAX_CONCURRENT:50}"
    feature_flags:
      gradual_rollout: true
      rollout_percentage: "${OPTIMIZATION_ROLLOUT_PERCENTAGE:100}"
      debug_logging: false
      fallback_on_error: true