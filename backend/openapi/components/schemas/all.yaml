# Aggregated component schemas for modular spec bundling
# This file consolidates all schema definitions so components.schemas can $ref here.
SuccessEnvelope:
  type: object
  properties:
    success:
      type: boolean
      description: Always true for success envelopes.
      default: true
      example: true
      readOnly: true
    metadata:
      $ref: '#/Metadata'
    requestId:
      type: string
  required: [success, requestId]
ErrorEnvelope:
  type: object
  properties:
    success:
      type: boolean
      description: Always false for error envelopes.
      default: false
      example: false
      readOnly: true
    error:
      $ref: '#/ApiError'
    requestId:
      type: string
  required: [success, error, requestId]
ErrorCode:
  type: string
  description: Stable error code space
  enum:
    - BAD_REQUEST
    - UNAUTHORIZED
    - FORBIDDEN
    - NOT_FOUND
    - CONFLICT
    - VALIDATION_ERROR
    - REQUIRED_FIELD
    - RATE_LIMIT_EXCEEDED
    - REQUEST_TIMEOUT
    - NOT_IMPLEMENTED
    - INTERNAL_SERVER_ERROR
    - DATABASE_ERROR
    - SERVICE_UNAVAILABLE
    - GATEWAY_TIMEOUT
    - CAMPAIGN_IN_PROGRESS
    - QUOTA_EXCEEDED
    - INVALID_STATE
ApiError:
  type: object
  properties:
    code:
      $ref: '#/ErrorCode'
    message:
      type: string
    details:
      type: array
      items:
        type: object
        properties:
          field:
            type: string
            description: JSON pointer or field path
          code:
            $ref: '#/ErrorCode'
          message:
            type: string
          context:
            type: object
            additionalProperties: true
        required: [code, message]
    timestamp:
      type: string
      format: date-time
    path:
      type: string
  required: [code, message, timestamp]
Metadata:
  type: object
  properties:
    page:
      $ref: '#/Pagination'
    rateLimit:
      $ref: '#/RateLimitInfo'
    processing:
      $ref: '#/ProcessingInfo'
    bulk:
      $ref: '#/BulkOperationInfo'
    extra:
      type: object
      additionalProperties: {}
Pagination:
  type: object
  properties:
    current: { type: integer }
    total: { type: integer }
    pageSize: { type: integer }
    count: { type: integer }
RateLimitInfo:
  type: object
  properties:
    limit: { type: integer }
    remaining: { type: integer }
    reset: { type: string, format: date-time }
ProcessingInfo:
  type: object
  properties:
    duration: { type: string }
    version: { type: string }
BulkOperationInfo:
  type: object
  properties:
    processedItems: { type: integer }
    skippedItems: { type: integer }
    failedItems:
      type: array
      items: { type: string }
    processingTimeMs: { type: integer, format: int64 }
    totalRowsReturned: { type: integer, format: int64 }
    type: { type: string }

# Direct response schemas (Option B - no envelope for 2xx)
HealthResponse:
  type: object
  properties:
    status:
      type: string
      enum: [ok]
    version:
      type: string
    uptime:
      type: string
    timestamp:
      type: string
      format: date-time
  required: [status]
  
PingResponse:
  type: object
  properties:
    message:
      type: string
      enum: [pong]
    timestamp:
      type: string
      format: date-time
    version:
      type: string
  required: [message]

# --- Scoring Profiles ---
ScoringProfile:
  type: object
  properties:
    id: { type: string, format: uuid }
    name: { type: string }
    description: { type: string, nullable: true }
    weights:
      type: object
      additionalProperties: { type: number, format: float }
    version: { type: integer }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
  required: [id, name, weights, version, createdAt, updatedAt]
CreateScoringProfileRequest:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    weights:
      type: object
      additionalProperties: { type: number, format: float }
    version:
      type: integer
      description: Optional explicit version; defaults to 1 if omitted
  required: [name, weights]
UpdateScoringProfileRequest:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    weights:
      type: object
      additionalProperties: { type: number, format: float }
    version: { type: integer }
AssociateScoringProfileRequest:
  type: object
  properties:
    profileId: { type: string, format: uuid }
  required: [profileId]
RescoreCampaignRequest:
  type: object
  description: Optional body for future rescore parameters (currently unused)

 # --- Campaign centralized state & phase execution ---
CampaignStateEnum:
  type: string
  enum: [draft, running, paused, completed, failed, cancelled, archived]
CampaignModeEnum:
  type: string
  enum: [full_sequence, step_by_step]
ExecutionStatusEnum:
  type: string
  enum: [not_started, ready, configured, in_progress, paused, completed, failed]

CampaignState:
  type: object
  properties:
    campaignId: { type: string, format: uuid }
    currentState: { $ref: '#/CampaignStateEnum' }
    mode: { $ref: '#/CampaignModeEnum' }
    configuration:
      type: object
      additionalProperties: {}
    version: { type: integer }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
  required: [campaignId, currentState, mode, version, createdAt, updatedAt]

CampaignStateUpdate:
  type: object
  properties:
    currentState: { $ref: '#/CampaignStateEnum' }
    mode: { $ref: '#/CampaignModeEnum' }
    configuration:
      type: object
      additionalProperties: {}
    version: { type: integer, description: Optional optimistic concurrency version; if provided must match current }

PhaseExecution:
  type: object
  properties:
    id: { type: string, format: uuid }
    campaignId: { type: string, format: uuid }
    phaseType:
      type: string
      description: Phase identifier
      enum: [discovery, validation, extraction, analysis]
    status: { $ref: '#/ExecutionStatusEnum' }
    startedAt: { type: string, format: date-time, nullable: true }
    completedAt: { type: string, format: date-time, nullable: true }
    pausedAt: { type: string, format: date-time, nullable: true }
    failedAt: { type: string, format: date-time, nullable: true }
    progressPercentage: { type: number, format: float }
    totalItems: { type: integer, format: int64 }
    processedItems: { type: integer, format: int64 }
    successfulItems: { type: integer, format: int64 }
    failedItems: { type: integer, format: int64 }
    configuration: { type: object, additionalProperties: {}, nullable: true }
    errorDetails: { type: object, additionalProperties: {}, nullable: true }
    metrics: { type: object, additionalProperties: {}, nullable: true }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
  required: [id, campaignId, phaseType, status, createdAt, updatedAt]

PhaseExecutionUpdate:
  type: object
  properties:
    status: { $ref: '#/ExecutionStatusEnum' }
    startedAt: { type: string, format: date-time, nullable: true }
    completedAt: { type: string, format: date-time, nullable: true }
    pausedAt: { type: string, format: date-time, nullable: true }
    failedAt: { type: string, format: date-time, nullable: true }
    progressPercentage: { type: number, format: float }
    totalItems: { type: integer, format: int64 }
    processedItems: { type: integer, format: int64 }
    successfulItems: { type: integer, format: int64 }
    failedItems: { type: integer, format: int64 }
    configuration: { type: object, additionalProperties: {}, nullable: true }
    errorDetails: { type: object, additionalProperties: {}, nullable: true }
    metrics: { type: object, additionalProperties: {}, nullable: true }

# Composite view
CampaignStateWithExecutions:
  type: object
  properties:
    campaignState: { $ref: '#/CampaignState' }
    phaseExecutions:
      type: array
      items: { $ref: '#/PhaseExecution' }
  required: [campaignState, phaseExecutions]

# Enriched composite view for UI read models
EnrichedCampaignResponse:
  type: object
  description: Read-optimized composite model for campaign detail pages
  properties:
    campaign:
      $ref: '#/CampaignResponse'
    state:
      $ref: '#/CampaignState'
    phaseExecutions:
      type: array
      items: { $ref: '#/PhaseExecution' }
  required: [campaign]

# --- Campaign Domains Listing & Pattern Offset Schemas ---
DomainListItem:
  type: object
  properties:
    id: { type: string, format: uuid }
    domain: { type: string }
    offset: { type: integer, format: int64 }
    createdAt: { type: string, format: date-time }
    dnsStatus: { type: string, description: "DNS validation status (authoritative)" }
    httpStatus: { type: string, description: "HTTP validation status (authoritative)" }
    leadStatus: { type: string, description: "Lead extraction status if available" }
    dnsReason: { type: string, nullable: true, description: "Human-readable reason string for current DNS status (e.g., NXDOMAIN, SERVFAIL, TIMEOUT, BAD_RESPONSE)" }
    httpReason: { type: string, nullable: true, description: "Human-readable reason string for current HTTP status (e.g., CONNECT_ERROR, TLS_ERROR, TIMEOUT, NON_200, BODY_MISMATCH)" }
    features:
      $ref: '#/DomainAnalysisFeatures'
  # required list declared above with properties; stray duplicated fields removed

DomainAnalysisFeatures:
  type: object
  description: Canonical nested analysis feature vector for a discovered domain.
  properties:
    keywords:
      type: object
      properties:
        unique_count: { type: integer, nullable: true }
        hits_total: { type: integer, nullable: true }
        weight_sum: { type: number, format: float, nullable: true }
        top3:
          type: array
          items: { type: string }
        signal_distribution:
          type: object
          additionalProperties: { type: number, format: float }
    richness:
      type: object
      properties:
        score: { type: number, format: float, nullable: true }
        version: { type: integer, nullable: true }
        prominence_norm: { type: number, format: float, nullable: true }
        diversity_effective_unique: { type: number, format: float, nullable: true }
        diversity_norm: { type: number, format: float, nullable: true }
        enrichment_norm: { type: number, format: float, nullable: true }
        applied_bonus: { type: number, format: float, nullable: true }
        applied_deductions_total: { type: number, format: float, nullable: true }
        stuffing_penalty: { type: number, format: float, nullable: true }
        repetition_index: { type: number, format: float, nullable: true }
        anchor_share: { type: number, format: float, nullable: true }
    microcrawl:
      type: object
      properties:
        gain_ratio: { type: number, format: float, nullable: true }
CampaignDomainsListResponse:
  type: object
  properties:
    campaignId: { type: string, format: uuid }
    items:
      type: array
      items: { $ref: '#/DomainListItem' }
    total: { type: integer }
    aggregates:
      type: object
      description: Domain status aggregates sourced from counters table (Phase A optimization)
      properties:
        dns:
          type: object
          properties:
            pending: { type: integer }
            ok: { type: integer }
            error: { type: integer }
            timeout: { type: integer }
        http:
          type: object
          properties:
            pending: { type: integer }
            ok: { type: integer }
            error: { type: integer }
            timeout: { type: integer }
        lead:
          type: object
          properties:
            pending: { type: integer }
            match: { type: integer }
            noMatch: { type: integer }
            error: { type: integer }
            timeout: { type: integer }
    pageInfo:
      $ref: '#/PageInfo'
  required: [campaignId, items, total]
PageInfo:
  type: object
  description: Cursor-based pagination metadata
  properties:
    startCursor: { type: string, nullable: true }
    endCursor: { type: string, nullable: true }
    hasNextPage: { type: boolean }
    sortBy: { type: string, description: Field used for ordering }
    sortOrder: { type: string, enum: [ASC, DESC] }
    first: { type: integer, description: Requested page size }
  required: [hasNextPage]
DomainScoreBreakdownResponse:
  type: object
  description: Component scores contributing to the final relevance score for a domain.
  properties:
    campaignId: { type: string, format: uuid }
    domain: { type: string }
    components:
      type: object
      description: Raw component scores normalized to 0-1 prior to weighting.
      properties:
        density: { type: number, format: float }
        coverage: { type: number, format: float }
        non_parked: { type: number, format: float }
        content_length: { type: number, format: float }
        title_keyword: { type: number, format: float }
        freshness: { type: number, format: float }
        tf_lite: { type: number, format: float, description: Experimental TF-lite component (0 if disabled) }
      required: [density, coverage, non_parked, content_length, title_keyword, freshness, tf_lite]
    final: { type: number, format: float, description: Weighted final relevance score after penalties }
    weights:
      type: object
      description: Active scoring profile weights used for combination.
      additionalProperties: { type: number, format: float }
    parkedPenaltyFactor:
      type: number
      format: float
      description: Penalty factor applied when domain considered parked with low confidence (<0.9)
  required: [campaignId, domain, components, final]
PatternOffsetRequest:
  type: object
  properties:
    patternType:
      type: string
      enum: [prefix, suffix, both]
    variableLength: { type: integer, minimum: 0 }
    characterSet: { type: string }
    constantString: { type: string }
    tld: { type: string, description: "Single TLD including dot, e.g. .com or without dot" }
  required: [patternType, variableLength, characterSet]
PatternOffsetResponse:
  type: object
  properties:
    currentOffset: { type: integer, format: int64 }
PersonaType:
  type: string
  enum: [dns, http]
ProxyProtocol:
  type: string
  enum: [http, https, socks5, socks4]
KeywordRuleType:
  type: string
  enum: [string, regex]

# Bulk operation cancel status enum (used by cancel API response)
BulkOperationCancelStatus:
  type: string
  enum: [cancelled, cancelling]

# Personas
PersonaConfigHttp:
  type: object
  description: HTTP persona configuration details
  properties:
    personaType: 
      type: string
      enum: [http]
      default: http
    userAgent: { type: string }
    headers:
      type: object
      additionalProperties: { type: string }
    headerOrder:
      type: array
      items: { type: string }
    tlsClientHello:
      type: object
      properties:
        minVersion: { type: string, enum: [TLS10, TLS11, TLS12, TLS13] }
        maxVersion: { type: string, enum: [TLS10, TLS11, TLS12, TLS13] }
        cipherSuites:
          type: array
          items: { type: string }
        curvePreferences:
          type: array
          items: { type: string }
    http2Settings:
      type: object
      properties:
        enabled: { type: boolean }
    cookieHandling:
      type: object
      properties:
        mode: { type: string, enum: [preserve, ignore, custom] }
    requestTimeoutSeconds: { type: integer, minimum: 0 }
    followRedirects: { type: boolean }
    allowedStatusCodes:
      type: array
      items: { type: integer, minimum: 100, maximum: 599 }
    rateLimitDps: { type: number, format: float, minimum: 0 }
    rateLimitBurst: { type: integer, minimum: 0 }
    notes: { type: string }
  required: [userAgent]
PersonaConfigDns:
  type: object
  description: DNS persona configuration details
  properties:
    personaType: 
      type: string
      enum: [dns]
      default: dns
    resolvers:
      type: array
      items: { type: string, description: Host:port or URL }
    useSystemResolvers: { type: boolean }
    queryTimeoutSeconds: { type: integer, minimum: 0 }
    maxDomainsPerRequest: { type: integer, minimum: 1 }
    resolverStrategy: { type: string, enum: [round_robin, random, weighted, priority] }
    resolversWeighted:
      type: object
      additionalProperties: { type: integer }
    resolversPreferredOrder:
      type: array
      items: { type: string }
    concurrentQueriesPerDomain: { type: integer, minimum: 1 }
    queryDelayMinMs: { type: integer, minimum: 0 }
    queryDelayMaxMs: { type: integer, minimum: 0 }
    maxConcurrentGoroutines: { type: integer, minimum: 1 }
    rateLimitDps: { type: number, format: float, minimum: 0 }
    rateLimitBurst: { type: integer, minimum: 0 }
  required: [resolvers, queryTimeoutSeconds, maxDomainsPerRequest, concurrentQueriesPerDomain]
PersonaConfigDetails:
  oneOf:
    - $ref: '#/PersonaConfigHttp'
    - $ref: '#/PersonaConfigDns'
  discriminator:
    propertyName: personaType
    mapping:
      http: '#/PersonaConfigHttp'
      dns: '#/PersonaConfigDns'
CreatePersonaRequest:
  type: object
  properties:
    name: { type: string }
    personaType: { $ref: '#/PersonaType' }
    description: { type: string }
    configDetails:
      $ref: '#/PersonaConfigDetails'
    isEnabled: { type: boolean }
  required: [name, personaType, configDetails]
UpdatePersonaRequest:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    configDetails:
      $ref: '#/PersonaConfigDetails'
    isEnabled: { type: boolean }
PersonaResponse:
  type: object
  properties:
    id: { type: string, format: uuid }
    name: { type: string }
    personaType: { $ref: '#/PersonaType' }
    description: { type: string }
    configDetails:
      $ref: '#/PersonaConfigDetails'
    isEnabled: { type: boolean }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
  required: [id, name, personaType, isEnabled, createdAt, updatedAt]
PersonaTestResponse:
  type: object
  properties:
    personaId: { type: string }
    personaType: { type: string }
    personaName: { type: string }
    success: { type: boolean }
    testPassed: { type: boolean }
    message: { type: string }
    testResults: { type: object }
    results: { type: object }
    timestamp: { type: string }
PersonaDeleteResponse:
  type: object
  properties:
    personaId: { type: string, format: uuid }
    deleted: { type: boolean }
    message: { type: string }
  required: [personaId, deleted]

# Proxies
CreateProxyRequestAPI:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    address: { type: string }
    protocol: { $ref: '#/ProxyProtocol' }
    username: { type: string }
    password: { type: string }
    countryCode: { type: string }
    isEnabled: { type: boolean }
    notes: { type: string }
  required: [name, address]
ProxyDetailsResponse:
  type: object
  properties:
    host: { type: string }
    port: { type: integer }
    protocol: { type: string }
    username: { type: string }
ProxyTestResponse:
  type: object
  properties:
    proxyId: { type: string, format: uuid }
    success: { type: boolean }
    statusCode: { type: integer }
    responseTime: { type: integer, format: int64 }
    error: { type: string }
UpdateProxyRequestAPI:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    address: { type: string }
    protocol: { $ref: '#/ProxyProtocol' }
    username: { type: string }
    password: { type: string }
    countryCode: { type: string }
    isEnabled: { type: boolean }
    notes: { type: string }
ProxyStatusResponse:
  type: object
  properties:
    proxyId: { type: string, format: uuid }
    status: { type: string }
    lastChecked: { type: string, format: date-time }
    responseTime: { type: integer, format: int64 }
    isHealthy: { type: boolean }
    proxyDetails: { $ref: '#/ProxyDetailsResponse' }
ProxyHealthCheckResponse:
  type: object
  properties:
    proxyId: { type: string, format: uuid }
    success: { type: boolean }
    status: { type: string }
    responseTime: { type: integer, format: int64 }
    message: { type: string }
    timestamp: { type: string, format: date-time }
BulkHealthCheckResponse:
  type: object
  properties:
    totalProxies: { type: integer }
    healthyProxies: { type: integer }
    failedProxies: { type: integer }
    results:
      type: array
      items: { $ref: '#/ProxyHealthCheckResponse' }
BulkProxyOperationResponse:
  type: object
  properties:
    totalRequested: { type: integer }
    successCount: { type: integer }
    errorCount: { type: integer }
    successfulProxies:
      type: array
      items: { type: string, format: uuid }
    failedProxies:
      type: array
      items:
        type: object
        properties:
          proxyId: { type: string, format: uuid }
          error: { type: string }
    results:
      type: array
      items:
        type: object
        additionalProperties: true
BulkUpdateProxiesRequest:
  type: object
  properties:
    proxyIds:
      type: array
      items: { type: string, format: uuid }
      minItems: 1
    updates: { $ref: '#/UpdateProxyRequestAPI' }
  required: [proxyIds, updates]
BulkDeleteProxiesRequest:
  type: object
  properties:
    proxyIds:
      type: array
      items: { type: string, format: uuid }
      minItems: 1
  required: [proxyIds]
BulkProxyTestResponse:
  type: object
  properties:
    totalRequested: { type: integer }
    successCount: { type: integer }
    errorCount: { type: integer }
    results:
      type: array
      items: { $ref: '#/ProxyTestResponse' }

# Proxy pools
ProxyPool:
  type: object
  properties:
    id: { type: string, format: uuid }
    name: { type: string }
    description: { type: string }
    isEnabled: { type: boolean }
    poolStrategy: { type: string }
    healthCheckEnabled: { type: boolean }
    healthCheckIntervalSeconds: { type: integer }
    maxRetries: { type: integer }
    timeoutSeconds: { type: integer }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
    proxies:
      type: array
      items: { type: object, additionalProperties: true }
ProxyPoolRequest:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    isEnabled: { type: boolean }
    poolStrategy: { type: string }
    healthCheckEnabled: { type: boolean }
    healthCheckIntervalSeconds: { type: integer }
    maxRetries: { type: integer }
    timeoutSeconds: { type: integer }
  required: [name]

ProxyPoolMembership:
  type: object
  properties:
    poolId: { type: string, format: uuid }
    proxyId: { type: string, format: uuid }
    weight: { type: integer }
    isActive: { type: boolean }
    addedAt: { type: string, format: date-time }
ProxyPoolMembershipResponse:
  type: object
  properties:
    poolId: { type: string, format: uuid }
    proxyId: { type: string, format: uuid }
    added: { type: boolean }
    removed: { type: boolean }
    message: { type: string }
ProxyPoolDeleteResponse:
  type: object
  properties:
    deleted: { type: boolean }
    poolId: { type: string, format: uuid }
    message: { type: string }

# Keyword sets / rules
KeywordRuleRequest:
  type: object
  properties:
    pattern: { type: string }
    ruleType: { $ref: '#/KeywordRuleType' }
    isCaseSensitive: { type: boolean }
    category: { type: string }
    contextChars: { type: integer }
  required: [pattern, ruleType]
CreateKeywordSetRequest:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    isEnabled: { type: boolean }
    rules:
      type: array
      items: { $ref: '#/KeywordRuleRequest' }
  required: [name]
KeywordRuleDTO:
  type: object
  properties:
    id: { type: string, format: uuid }
    keywordSetId: { type: string, format: uuid }
    pattern: { type: string }
    ruleType: { type: string }
    isCaseSensitive: { type: boolean }
    category: { type: string }
    contextChars: { type: integer }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
KeywordSetResponse:
  type: object
  properties:
    id: { type: string, format: uuid }
    name: { type: string }
    description: { type: string }
    isEnabled: { type: boolean }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
    rules:
      type: array
      items: { $ref: '#/KeywordRuleDTO' }
    ruleCount: { type: integer }
  required: [id, name, isEnabled, createdAt, updatedAt, ruleCount]
UpdateKeywordSetRequest:
  type: object
  properties:
    name: { type: string }
    description: { type: string }
    isEnabled: { type: boolean }
    rules:
      type: array
      items: { $ref: '#/KeywordRuleRequest' }
KeywordSetWithRulesResponse:
  type: object
  properties:
    id: { type: string, format: uuid }
    name: { type: string }
    description: { type: string }
    isEnabled: { type: boolean }
    createdAt: { type: string, format: date-time }
    updatedAt: { type: string, format: date-time }
    rules:
      type: array
      items: { $ref: '#/KeywordRuleDTO' }
    ruleCount: { type: integer }
  required: [id, name, isEnabled, createdAt, updatedAt, rules, ruleCount]

# Extraction
BatchKeywordExtractionRequest:
  type: object
  properties:
    items:
      type: array
      items:
        type: object
        properties:
          url: { type: string, format: uri }
          keywordSetId: { type: string, format: uuid }
          httpPersonaId: { type: string, format: uuid }
          dnsPersonaId: { type: string, format: uuid }
        required: [url, keywordSetId]
  required: [items]
BatchKeywordExtractionResponse:
  type: object
  properties:
    results:
      type: array
      items:
        type: object
        properties:
          url: { type: string, format: uri }
          keywordSetIdUsed: { type: string, format: uuid }
          httpPersonaIdUsed: { type: string, format: uuid }
          dnsPersonaIdUsed: { type: string, format: uuid }
          proxyIdUsed: { type: string, format: uuid }
          finalURL: { type: string, format: uri }
          statusCode: { type: integer }
          matches:
            type: array
            items:
              type: object
              properties:
                matchedPattern: { type: string }
                matchedText: { type: string }
                category: { type: string }
                contexts:
                  type: array
                  items: { type: string }
          error: { type: string }

# Database bulk
BulkDatabaseQueryRequest:
  type: object
  properties:
    queries:
      type: array
      items:
        type: object
        properties:
          id: { type: string }
          sql: { type: string }
        required: [id, sql]
    limit: { type: integer }
    timeout: { type: integer }
  required: [queries]
BulkDatabaseQueryResponse:
  type: object
  properties:
    results:
      type: object
      additionalProperties:
        type: object
        properties:
          columns: { type: array, items: { type: string } }
          rows:
            type: array
            items:
              type: array
              items:
                $ref: '#/DatabaseValue'
          rowCount: { type: integer }
          executionTime: { type: integer, format: int64 }
          success: { type: boolean }
          error: { type: string }
    totalCount: { type: integer }
DatabaseValue:
  type: object
  properties:
    stringValue: { type: string }
    intValue: { type: integer, format: int64 }
    floatValue: { type: number }
    boolValue: { type: boolean }
    isNull: { type: boolean }
    rawValue: { type: string }
# Database stats
BulkDatabaseStatsRequest:
  type: object
  properties:
    schemas:
      type: array
      items: { type: string }
    tables:
      type: array
      items: { type: string }
    includeIndexes: { type: boolean }
    includeSize: { type: boolean }
  additionalProperties: false
BulkDatabaseStatsResponse:
  type: object
  properties:
    databaseStats: { $ref: '#/DatabaseStats' }
    schemaStats:
      type: object
      additionalProperties:
        $ref: '#/SchemaStats'
    tableStats:
      type: object
      additionalProperties:
        $ref: '#/TableStats'
    totalCount: { type: integer }
DatabaseStats:
  description: Overall database statistics
  type: object
  properties:
    totalTables: { type: integer }
    totalUsers: { type: integer }
    totalSessions: { type: integer }
    databaseSize: { type: string }
    schemaVersion: { type: string }
    uptime: { type: string }
    version: { type: string }
    isHealthy: { type: boolean }
SchemaStats:
  description: Statistics for a specific database schema
  type: object
  properties:
    name: { type: string }
    tableCount: { type: integer }
    totalRows: { type: integer }
    totalSize: { type: string }
TableStats:
  description: Statistics for a specific table
  type: object
  properties:
    name: { type: string }
    rowCount: { type: integer }
    size: { type: string }
    indexes: { type: array, items: { type: string } }

# Config schemas
AuthConfig:
  type: object
  description: Authentication configuration
  additionalProperties: true
LoggingConfig:
  type: object
  description: Logging configuration
  additionalProperties: true
DNSValidatorConfigJSON:
  type: object
  description: DNS validator configuration
  additionalProperties: true
HTTPValidatorConfigJSON:
  type: object
  description: HTTP validator configuration
  additionalProperties: true
WorkerConfig:
  type: object
  description: Worker configuration
  additionalProperties: true
WorkerConfigUpdate:
  type: object
  description: Worker configuration update payload
  properties:
    poolSize:
      type: integer
      minimum: 1
      maximum: 1000
      description: Number of worker threads in the pool
    maxJobs:
      type: integer
      minimum: 1
      maximum: 10000
      description: Maximum number of jobs in queue
    jobTimeout:
      type: integer
      minimum: 1
      maximum: 3600
      description: Job execution timeout in seconds
    idleTimeout:
      type: integer
      minimum: 1
      maximum: 300
      description: Worker idle timeout in seconds
    retryAttempts:
      type: integer
      minimum: 0
      maximum: 10
      description: Number of retry attempts for failed jobs
    retryDelay:
      type: integer
      minimum: 100
      maximum: 60000
      description: Delay between retries in milliseconds
    enableMetrics:
      type: boolean
      description: Enable worker performance metrics collection
    metricsInterval:
      type: integer
      minimum: 1
      maximum: 3600
      description: Metrics collection interval in seconds
    priority:
      type: string
      enum: [low, normal, high, critical]
      description: Worker pool priority level
    enableHealthChecks:
      type: boolean
      description: Enable worker health monitoring
    healthCheckInterval:
      type: integer
      minimum: 5
      maximum: 300
      description: Health check interval in seconds
RateLimiterConfig:
  type: object
  description: Rate limiter configuration
  additionalProperties: true
ProxyManagerConfigJSON:
  type: object
  description: Proxy manager configuration
  additionalProperties: true
ServerConfigResponse:
  type: object
  description: Consolidated server configuration response
  additionalProperties: true
ServerConfigUpdateRequest:
  type: object
  description: Server configuration update request
  additionalProperties: true

# Feature flags
FeatureFlags:
  type: object
  description: Feature flags map
  additionalProperties:
    type: boolean

# Auth
LoginRequest:
  type: object
  properties:
    email: { type: string, format: email }
    password: { type: string, format: password }
  required: [email, password]
SessionResponse:
  type: object
  properties:
    user: { $ref: '#/UserPublicResponse' }
    token: { type: string }
    refreshToken: { type: string }
    expiresAt: { type: string, format: date-time }
  required: [user, token, expiresAt]
UserPublicResponse:
  type: object
  properties:
    id: { type: string, format: uuid }
    username: { type: string }
    email: { type: string, format: email }
    isActive: { type: boolean }
  required: [id, username, email, isActive]

# Campaigns
CreateCampaignRequest:
  type: object
  properties:
    name:
      type: string
      description: Campaign name
      minLength: 1
      maxLength: 255
    description:
      type: string
      description: Campaign description
    configuration:
      type: object
      description: Campaign configuration settings
      properties:
        maxDomains:
          type: integer
          minimum: 1
          maximum: 1000000
          description: Maximum number of domains to process
        phases:
          type: object
          properties:
            discovery:
              type: object
              properties:
                enabled: { type: boolean }
                maxDepth: { type: integer, minimum: 1, maximum: 10 }
            validation:
              type: object
              properties:
                enabled: { type: boolean }
                dnsValidation: { type: boolean }
                httpValidation: { type: boolean }
            extraction:
              type: object
              properties:
                enabled: { type: boolean }
                keywordSetIds:
                  type: array
                  items: { type: string, format: uuid }
            analysis:
              type: object
              properties:
                enabled: { type: boolean }
                generateReports: { type: boolean }
        patternConfig:
          type: object
          description: Domain generation pattern configuration snapshot
          properties:
            type: { type: string, enum: [constant, variable] }
            constant: { type: string, description: Constant pattern string when type=constant }
            variableLength: { type: integer, minimum: 1, maximum: 64, description: Desired variable length for generation }
            charset: { type: string, description: Character set used for variable generation }
            targetDomains:
              type: array
              items: { type: string }
            tlds:
              type: array
              items: { type: string }
            keywordSetIds:
              type: array
              items: { type: string, format: uuid }
            personaIds:
              type: array
              items: { type: string, format: uuid }
            crawlDepth: { type: integer, minimum: 0, maximum: 5 }
            projectionEstimate:
              type: object
              description: Optional projection estimate payload for UI modeling
              additionalProperties: true
          required: [type]
  required: [name]
UpdateCampaignRequest:
  type: object
  properties:
    name:
      type: string
      minLength: 1
      maxLength: 255
    description:
      type: string
    configuration:
      type: object
      description: Campaign configuration settings (same structure as CreateCampaignRequest)
CampaignResponse:
  type: object
  properties:
    id:
      type: string
      format: uuid
    name:
      type: string
    description:
      type: string
    status:
      type: string
      enum: [draft, running, paused, completed, failed, cancelled]
    configuration:
      type: object
      description: Campaign configuration
    currentPhase:
      type: string
      enum: [discovery, validation, extraction, analysis]
      nullable: true
    progress:
      type: object
      properties:
        totalDomains: { type: integer }
        processedDomains: { type: integer }
        successfulDomains: { type: integer }
        failedDomains: { type: integer }
        percentComplete: { type: number, format: float }
    createdAt:
      type: string
      format: date-time
    updatedAt:
      type: string
      format: date-time
    startedAt:
      type: string
      format: date-time
      nullable: true
    completedAt:
      type: string
      format: date-time
      nullable: true
  required: [id, name, status, configuration, progress, createdAt, updatedAt]
PhaseConfigurationRequest:
  type: object
  properties:
    configuration:
      type: object
      description: Phase-specific configuration
      additionalProperties: true
    personaIds:
      type: object
      properties:
        httpPersonaId:
          type: string
          format: uuid
          nullable: true
        dnsPersonaId:
          type: string
          format: uuid
          nullable: true
    proxyPoolId:
      type: string
      format: uuid
      nullable: true
    keywordSetIds:
      type: array
      items:
        type: string
        format: uuid
      description: Keyword sets for extraction phase
  required: [configuration]
PhaseStatusResponse:
  type: object
  properties:
    phase:
      type: string
      enum: [discovery, validation, extraction, analysis]
    status:
      type: string
      enum: [not_started, configured, running, paused, completed, failed]
    configuration:
      type: object
      description: Current phase configuration
    startedAt:
      type: string
      format: date-time
      nullable: true
    completedAt:
      type: string
      format: date-time
      nullable: true
    progress:
      type: object
      properties:
        totalItems: { type: integer }
        processedItems: { type: integer }
        successfulItems: { type: integer }
        failedItems: { type: integer }
        percentComplete: { type: number, format: float }
    errors:
      type: array
      items:
        type: object
        properties:
          message: { type: string }
          timestamp: { type: string, format: date-time }
          code: { type: string }
  required: [phase, status, progress]
CampaignProgressResponse:
  type: object
  properties:
    campaignId:
      type: string
      format: uuid
    overall:
      type: object
      properties:
        status:
          type: string
          enum: [draft, running, paused, completed, failed, cancelled]
        percentComplete: { type: number, format: float }
        totalDomains: { type: integer }
        processedDomains: { type: integer }
        successfulDomains: { type: integer }
        failedDomains: { type: integer }
    phases:
      type: object
      properties:
        discovery:
          $ref: '#/PhaseProgressSummary'
        validation:
          $ref: '#/PhaseProgressSummary'
        extraction:
          $ref: '#/PhaseProgressSummary'
        analysis:
          $ref: '#/PhaseProgressSummary'
    timeline:
      type: object
      properties:
        createdAt: { type: string, format: date-time }
        startedAt: { type: string, format: date-time, nullable: true }
        estimatedCompletionAt: { type: string, format: date-time, nullable: true }
        completedAt: { type: string, format: date-time, nullable: true }
  required: [campaignId, overall, phases, timeline]
PhaseProgressSummary:
  type: object
  properties:
    status:
      type: string
      enum: [not_started, configured, running, paused, completed, failed]
    percentComplete: { type: number, format: float }
    itemsProcessed: { type: integer }
    itemsTotal: { type: integer }
    startedAt: { type: string, format: date-time, nullable: true }
    completedAt: { type: string, format: date-time, nullable: true }
    duration: { type: string, nullable: true, description: "Human readable duration" }
  required: [status, percentComplete, itemsProcessed, itemsTotal]

# --- Unified Campaign UX Refactor Schemas ---
CampaignPhasesStatusResponse:
  type: object
  description: Consolidated phase status list plus overall progress
  properties:
    campaignId: { type: string, format: uuid }
    overallProgressPercentage: { type: number, format: float }
    phases:
      type: array
      items:
        type: object
        properties:
          phase: { type: string, enum: [generation, dns, http, analysis, leads] }
          status: { type: string, enum: [not_started, ready, configured, in_progress, paused, completed, failed] }
          progressPercentage: { type: number, format: float }
          startedAt: { type: string, format: date-time, nullable: true }
          completedAt: { type: string, format: date-time, nullable: true }
        required: [phase, status, progressPercentage]
  required: [campaignId, overallProgressPercentage, phases]

CampaignFunnelResponse:
  type: object
  properties:
    generated: { type: integer }
    dnsValid: { type: integer }
    httpValid: { type: integer }
    keywordHits: { type: integer }
    analyzed: { type: integer }
    highPotential: { type: integer }
    leads: { type: integer }
  required: [generated, dnsValid, httpValid, keywordHits, analyzed, highPotential, leads]

CampaignMetricsResponse:
  type: object
  description: KPI and warning component metrics for a campaign
  properties:
    highPotential: { type: integer }
    leads: { type: integer }
    keywordCoveragePct: { type: number, format: float }
    avgRichness: { type: number, format: float }
    warningRatePct: { type: number, format: float }
    medianGain: { type: number, format: float }
    stuffing: { type: integer }
    repetition: { type: integer }
    anchor: { type: integer }
    totalAnalyzed: { type: integer }
  required: [highPotential, leads, keywordCoveragePct, avgRichness, warningRatePct, medianGain, stuffing, repetition, anchor, totalAnalyzed]

CampaignClassificationBucketSample:
  type: object
  properties:
    bucket: { type: string, enum: [highPotential, emerging, atRisk, leadCandidate, lowValue, other] }
    domains:
      type: array
      items:
        type: object
        properties:
          domain: { type: string }
          richness: { type: number, format: float, nullable: true }
        required: [domain]
  required: [bucket, domains]

CampaignClassificationsResponse:
  type: object
  properties:
    counts:
      type: object
      properties:
        highPotential: { type: integer }
        emerging: { type: integer }
        atRisk: { type: integer }
        leadCandidate: { type: integer }
        lowValue: { type: integer }
        other: { type: integer }
      required: [highPotential, emerging, atRisk, leadCandidate, lowValue, other]
    samples:
      type: array
      items: { $ref: '#/CampaignClassificationBucketSample' }
  required: [counts]

CampaignMomentumResponse:
  type: object
  properties:
    moversUp:
      type: array
      items:
        type: object
        properties:
          domain: { type: string }
          delta: { type: number, format: float }
        required: [domain, delta]
    moversDown:
      type: array
      items:
        type: object
        properties:
          domain: { type: string }
          delta: { type: number, format: float }
        required: [domain, delta]
    histogram:
      type: array
      items: { type: integer }
      minItems: 5
      maxItems: 5
  required: [moversUp, moversDown, histogram]

RecommendationSeverity:
  type: string
  enum: [info, warn, action]

CampaignRecommendation:
  type: object
  properties:
    id: { type: string }
    message: { type: string }
    rationaleCode:
      type: string
      enum: [R_DNS_LOW, R_HTTP_LOW, R_FEW_HIGH_POTENTIAL, R_WARNING_RATE_HIGH, R_NO_LEADS, R_MOMENTUM_LOSS, R_MOMENTUM_SURGE, R_ALL_CLEAR]
    severity: { $ref: '#/RecommendationSeverity' }
  required: [id, message, rationaleCode, severity]

CampaignRecommendationsResponse:
  type: object
  properties:
    recommendations:
      type: array
      items: { $ref: '#/CampaignRecommendation' }
  required: [recommendations]

# Bulk operations
BulkDNSValidationRequest:
  type: object
  properties:
    operations:
      type: array
      items:
        type: object
        properties:
          campaignId:
            type: string
            format: uuid
          personaIds:
            type: array
            items:
              type: string
              format: uuid
          maxDomains:
            type: integer
            minimum: 1
            maximum: 10000
          validationConfig:
            type: object
            properties:
              timeout: { type: integer, minimum: 1000, maximum: 30000 }
              retries: { type: integer, minimum: 0, maximum: 5 }
              recordTypes: { type: array, items: { type: string, enum: [A, AAAA, MX, NS, CNAME] } }
        required: [campaignId, personaIds]
      minItems: 1
      maxItems: 50
    batchSize:
      type: integer
      minimum: 1
      maximum: 1000
      default: 100
    stealth:
      type: object
      properties:
        enabled: { type: boolean, default: true }
        randomizationLevel: { type: string, enum: [low, medium, high, extreme], default: medium }
        delayRange: { type: object, properties: { min: { type: integer }, max: { type: integer } } }
  required: [operations]

BulkHTTPValidationRequest:
  type: object
  properties:
    operations:
      type: array
      items:
        type: object
        properties:
          campaignId:
            type: string
            format: uuid
          personaIds:
            type: array
            items:
              type: string
              format: uuid
          keywords:
            type: array
            items:
              type: string
          maxDomains:
            type: integer
            minimum: 1
            maximum: 10000
          validationConfig:
            type: object
            properties:
              timeout: { type: integer, minimum: 5000, maximum: 60000 }
              followRedirects: { type: boolean, default: true }
              userAgent: { type: string }
              headers: { type: object, additionalProperties: { type: string } }
        required: [campaignId, personaIds, keywords]
      minItems: 1
      maxItems: 50
    batchSize:
      type: integer
      minimum: 1
      maximum: 500
      default: 50
    stealth:
      type: object
      properties:
        enabled: { type: boolean, default: true }
        randomizationLevel: { type: string, enum: [low, medium, high, extreme], default: high }
        delayRange: { type: object, properties: { min: { type: integer }, max: { type: integer } } }
  required: [operations]

# Analytics
BulkAnalyticsRequest:
  type: object
  properties:
    campaignIds:
      type: array
      items:
        type: string
        format: uuid
      minItems: 1
      maxItems: 100
    metrics:
      type: array
      items:
        type: string
        enum: [response_time, content_analysis, lead_score, domain_health, keyword_density]
    granularity:
      type: string
      enum: [hour, day, week, month]
      default: day
    timeRange:
      type: object
      properties:
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }
        timezone: { type: string, default: UTC }
      required: [startTime, endTime]
    aggregation:
      type: object
      properties:
        groupBy: { type: array, items: { type: string } }
        functions: { type: array, items: { type: string, enum: [sum, avg, min, max, count] } }
  required: [campaignIds, metrics, timeRange]

# Duplicate BulkAnalyticsResponse removed (defined earlier)

BulkDomainGenerationRequest:
  type: object
  properties:
    operations:
      type: array
      items:
        type: object
        properties:
          campaignId:
            type: string
            format: uuid
          config:
            type: object
            properties:
              patternType: { type: string, enum: [prefix, suffix, both] }
              variableLength: { type: integer, minimum: 0, maximum: 20 }
              characterSet: { type: string }
              constantString: { type: string }
              tlds: { type: array, items: { type: string } }
              numDomainsToGenerate: { type: integer, minimum: 1, maximum: 1000000 }
              batchSize: { type: integer, minimum: 1, maximum: 10000 }
            required: [patternType, variableLength, characterSet, constantString, tlds, numDomainsToGenerate]
          maxDomains:
            type: integer
            minimum: 1
            maximum: 1000000
        required: [campaignId, config, maxDomains]
      minItems: 1
      maxItems: 100
    batchSize:
      type: integer
      minimum: 1
      maximum: 10000
      default: 1000
    parallel:
      type: boolean
      default: true
  required: [operations]

BulkValidationResponse:
  type: object
  properties:
    operationId:
      type: string
      format: uuid
    status:
      type: string
      enum: [initiated, pending, running]
    operations:
      type: object
      additionalProperties:
        type: object
        properties:
          campaignId: { type: string, format: uuid }
          status: { type: string, enum: [pending, running, completed, failed] }
          progress: { type: object, properties: { processed: { type: integer }, total: { type: integer } } }
          estimatedCompletion: { type: string, format: date-time, nullable: true }
    totalOperations:
      type: integer
    estimatedDuration:
      type: string
      nullable: true
  required: [operationId, status, operations, totalOperations]

BulkGenerationResponse:
  type: object
  properties:
    operationId:
      type: string
      format: uuid
    status:
      type: string
      enum: [initiated, pending, running]
    operations:
      type: object
      additionalProperties:
        type: object
        properties:
          campaignId: { type: string, format: uuid }
          status: { type: string, enum: [pending, running, completed, failed] }
          domainsGenerated: { type: integer }
          progress: { type: object, properties: { processed: { type: integer }, total: { type: integer } } }
    totalOperations:
      type: integer
    estimatedDuration:
      type: string
      nullable: true
  required: [operationId, status, operations, totalOperations]

BulkAnalyticsResponse:
  type: object
  properties:
    operationId:
      type: string
      format: uuid
    status:
      type: string
      enum: [initiated, pending, running, completed]
    analytics:
      type: object
      properties:
        totalCampaigns: { type: integer }
        totalDomains: { type: integer }
        totalLeads: { type: integer }
        overallSuccessRate: { type: number, format: float }
        topPerformingTLDs:
          type: array
          items:
            type: object
            properties:
              tld: { type: string }
              domains: { type: integer }
              leads: { type: integer }
              successRate: { type: number, format: float }
              rank: { type: integer }
        performanceMetrics:
          type: object
          properties:
            avgResponseTime: { type: number, format: float }
            avgLeadScore: { type: number, format: float }
            conversionRate: { type: number, format: float }
    processedCampaigns:
      type: integer
    estimatedCompletion:
      type: string
      format: date-time
      nullable: true
  required: [operationId, status, processedCampaigns]

BulkResourceAllocationRequest:
  type: object
  properties:
    operationType:
      type: string
      enum: [domain_generation, dns_validation, http_validation, analytics]
    resources:
      type: object
      properties:
        cpu: { type: integer, minimum: 1, maximum: 64, description: "CPU cores" }
        memory: { type: integer, minimum: 1, maximum: 128, description: "Memory in GB" }
        networkBandwidth: { type: integer, minimum: 10, maximum: 10000, description: "Bandwidth in Mbps" }
        storage: { type: integer, minimum: 1, maximum: 1000, description: "Storage in GB" }
    priority:
      type: string
      enum: [low, normal, high, critical]
      default: normal
    duration:
      type: integer
      minimum: 300
      maximum: 86400
      description: Resource allocation duration in seconds
    tags:
      type: object
      additionalProperties: { type: string }
      description: Resource allocation tags for tracking
  required: [operationType, resources, duration]

BulkResourceAllocationResponse:
  type: object
  properties:
    allocationId:
      type: string
      format: uuid
    status:
      type: string
      enum: [allocating, allocated, failed]
    resources:
      type: object
      properties:
        cpu: { type: integer }
        memory: { type: integer }
        networkBandwidth: { type: integer }
        storage: { type: integer }
    allocation:
      type: object
      properties:
        allocatedAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }
        estimatedCost: { type: number, format: float, nullable: true }
    endpoints:
      type: object
      properties:
        monitoring: { type: string, format: uri }
        metrics: { type: string, format: uri }
        control: { type: string, format: uri }
  required: [allocationId, status, resources, allocation]
