#!/usr/bin/env node
/*
Compare OpenAPI bundled paths vs Gin dumped routes.
- Reads backend/openapi/dist/openapi.yaml
- Reads backend/routes.dump.txt (generated by: go run dump_routes.go | tee routes.dump.txt)
- Normalizes Gin routes by stripping leading /api/v2
- Reports differences in both directions
*/
const fs = require('fs');
const path = require('path');
const yaml = require('js-yaml');

const BUNDLE = path.resolve(__dirname, '../backend/openapi/dist/openapi.yaml');
const ROUTES_DUMP = path.resolve(__dirname, '../backend/routes.dump.txt');

function loadBundle(file) {
  const src = fs.readFileSync(file, 'utf8');
  const doc = yaml.load(src);
  const paths = doc.paths || {};
  const specSet = new Set();
  for (const [p, obj] of Object.entries(paths)) {
    if (!obj || typeof obj !== 'object') continue;
    // Normalize trailing slash for consistent comparison
    const normPath = p !== '/' && p.endsWith('/') ? p.replace(/\/+$/, '') : p;
    for (const m of ['get', 'post', 'put', 'delete', 'patch', 'options', 'head']) {
      if (obj[m]) specSet.add(`${m.toUpperCase()} ${normPath}`);
    }
  }
  return specSet;
}

function loadGinDump(file) {
  const src = fs.readFileSync(file, 'utf8');
  const lines = src.split(/\r?\n/).filter(Boolean);
  const ginSet = new Set();
  for (const line of lines) {
    const m = line.match(/^(GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS)\s+(\S+)/);
    if (!m) continue;
    let p = m[2];
    // Normalize: strip /api/v2 prefix for comparison with spec paths
    if (p.startsWith('/api/v2')) p = p.slice('/api/v2'.length) || '/';
    // Normalize Gin params :id to OpenAPI style {id}
    p = p.replace(/:([A-Za-z0-9_]+)/g, '{$1}');
    // Normalize trailing slashes (except root)
    if (p !== '/' && p.endsWith('/')) p = p.replace(/\/+$/, '');
    ginSet.add(`${m[1]} ${p}`);
  }
  return ginSet;
}

function diff(a, b) {
  const out = [];
  for (const x of a) if (!b.has(x)) out.push(x);
  return out.sort();
}

function main() {
  if (!fs.existsSync(BUNDLE)) {
    console.error(`Bundle not found: ${BUNDLE}`);
    process.exit(1);
  }
  if (!fs.existsSync(ROUTES_DUMP)) {
    console.error(`Routes dump not found: ${ROUTES_DUMP}`);
    process.exit(2);
  }
  const specSet = loadBundle(BUNDLE);
  const ginSet = loadGinDump(ROUTES_DUMP);

  const missingInSpec = diff(ginSet, specSet);
  const missingInGin = diff(specSet, ginSet);

  const report = {
    totals: {
      specCount: specSet.size,
      ginCount: ginSet.size,
      missingInSpec: missingInSpec.length,
      missingInGin: missingInGin.length,
    },
    missingInSpec,
    missingInGin,
  };
  console.log(JSON.stringify(report, null, 2));
}

main();
