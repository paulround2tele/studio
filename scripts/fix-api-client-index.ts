#!/usr/bin/env tsx

/*
 * Post-Generation API Client Index Fixer
 * 
 * This script fixes the garbage index.ts file that the OpenAPI generator creates.
 * It properly exports all APIs and models at the top level for professional usage.
 * 
 * WHY THIS IS NEEDED:
 * The OpenAPI generator only exports 3 categories (api, models, configuration)
 * instead of exposing all the individual API classes and model types.
 * This forces amateur import patterns instead of professional ones.
 * 
 * ADDITIONAL PROBLEM: The models/index.ts only exports api-* prefixed models
 * but not the short-form models that components actually need.
 */

import { writeFileSync, readFileSync, readdirSync } from 'fs';
import path from 'path';

const API_CLIENT_DIR = path.join(process.cwd(), 'src/lib/api-client');
const INDEX_FILE = path.join(API_CLIENT_DIR, 'index.ts');
const MODELS_DIR = path.join(API_CLIENT_DIR, 'models');
const MODELS_INDEX_FILE = path.join(MODELS_DIR, 'index.ts');
const APIS_DIR = path.join(API_CLIENT_DIR, 'apis');

/**
 * Fix the models/index.ts to export ALL models (not just api-* prefixed ones)
 * EXCEPT legacy garbage that conflicts with professional types
 */
function fixModelsIndex(): void {
  console.log('üîß Fixing models/index.ts to export all models...');
  
  try {
    // Get all .ts files in the models directory
    const modelFiles = readdirSync(MODELS_DIR)
      .filter(file => file.endsWith('.ts') && file !== 'index.ts')
      .filter(file => {
        // EXCLUDE legacy garbage that conflicts with professional types
        const modelName = file.replace('.ts', '');
        const legacyGarbage = [
          'apiresponse', // We have professional APIResponse in unified-types
          'api-response', // Redundant with above
        ];
        
        if (legacyGarbage.includes(modelName.toLowerCase())) {
          console.log(`üóëÔ∏è  Excluding legacy garbage: ${modelName}`);
          return false;
        }
        
        return true;
      })
      .sort();
    
    // Generate comprehensive models index
    const modelsIndexContent = `/* tslint:disable */
/* eslint-disable */
/**
 * Comprehensive Models Index
 * 
 * Exports ALL model types (both api-* prefixed and short-form)
 * EXCLUDES legacy garbage that conflicts with professional unified types
 * Fixed by post-generation script: ${new Date().toISOString()}
 * 
 * NOTE: This file is auto-regenerated after OpenAPI generation.
 * Do not edit manually - your changes will be overwritten.
 */

${modelFiles.map(file => {
  const modelName = file.replace('.ts', '');
  return `export * from './${modelName}';`;
}).join('\n')}
`;

    writeFileSync(MODELS_INDEX_FILE, modelsIndexContent, 'utf8');
    console.log(`‚úÖ Models index fixed! Now exporting ${modelFiles.length} model files`);
    
  } catch (error) {
    console.error('‚ùå Failed to fix models index:', error);
    throw error;
  }
}

/**
 * Fix the auto-generated api.ts file to exclude legacy garbage and enum conflicts
 */
function fixLegacyApiFile(): void {
  console.log('üîß Fixing legacy api.ts file...');
  
  const API_FILE = path.join(API_CLIENT_DIR, 'api.ts');
  
  try {
    // Generate a clean api.ts without conflicts
    const cleanApiContent = `/* tslint:disable */
/* eslint-disable */
/**
 * Domain Flow API
 * A comprehensive API for domain generation, validation, and management operations.
 *
 * The version of the OpenAPI document: 1.0
 * Contact: support@swagger.io
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * 
 * MODIFIED BY POST-GENERATION SCRIPT to remove enum conflicts and legacy garbage
 * Do not edit the class manually - use the post-generation script instead.
 */



export * from './apis/analytics-api';
export * from './apis/authentication-api';

// Export bulk-operations-api first to take precedence for shared enums
export * from './apis/bulk-operations-api';

export * from './apis/campaigns-api';
export * from './apis/database-api';
export * from './apis/domains-api';
export * from './apis/feature-flags-api';
export * from './apis/health-api';
export * from './apis/keyword-extraction-api';
export * from './apis/keyword-sets-api';
export * from './apis/management-api';

// Export monitoring-api with explicit excludes to avoid enum conflicts
export {
  MonitoringApi,
  MonitoringApiAxiosParamCreator,
  MonitoringApiFp,
  MonitoringApiFactory
} from './apis/monitoring-api';

export * from './apis/personas-api';
export * from './apis/proxies-api';
export * from './apis/proxy-pools-api';
export * from './apis/resources-api';
export * from './apis/server-settings-api';
export * from './apis/sse-api';
export * from './apis/validation-api';
export * from './apis/websocket-api';


`;
    
    writeFileSync(API_FILE, cleanApiContent, 'utf8');
    console.log('‚úÖ Legacy api.ts file fixed - enum conflicts and legacy garbage removed');
    
  } catch (error) {
    console.error('‚ùå Failed to fix legacy api.ts file:', error);
    throw error;
  }
}

/**
 * Generate a professional index.ts that exposes everything properly
 */
function generateProfessionalIndex(): string {
  return `/* tslint:disable */
/* eslint-disable */
/**
 * Domain Flow API Client
 * Professional index that exposes all APIs and models properly
 * 
 * Generated by: ${new Date().toISOString()}
 * 
 * NOTE: This file is auto-regenerated after OpenAPI generation.
 * Do not edit manually - your changes will be overwritten.
 */

// ==================================================
// CORE CONFIGURATION & BASE CLASSES
// ==================================================
export * from './configuration';
export * from './base';
export * from './common';

// ==================================================
// ALL API CLASSES (Professional Access)
// ==================================================
export * from './apis/analytics-api';
export * from './apis/authentication-api';

// Export bulk-operations-api first to take precedence for shared enums
export * from './apis/bulk-operations-api';

export * from './apis/campaigns-api';
export * from './apis/database-api';
export * from './apis/domains-api';
export * from './apis/feature-flags-api';
export * from './apis/health-api';
export * from './apis/keyword-extraction-api';
export * from './apis/keyword-sets-api';
export * from './apis/management-api';

// Export monitoring-api with explicit excludes to avoid enum conflicts
export {
  MonitoringApi,
  MonitoringApiAxiosParamCreator,
  MonitoringApiFp,
  MonitoringApiFactory
} from './apis/monitoring-api';

export * from './apis/personas-api';
export * from './apis/proxies-api';
export * from './apis/proxy-pools-api';
export * from './apis/resources-api';
export * from './apis/server-settings-api';
export * from './apis/sse-api';
export * from './apis/validation-api';
export * from './apis/websocket-api';

// ==================================================
// ALL MODEL TYPES (Professional Access)
// ==================================================
export * from './models';

// ==================================================
// PROFESSIONAL API CLIENT (Recommended)
// ==================================================
// Professional unified types (no more legacy APIResponse conflicts!)
export * from './unified-types';
export * from './unified-client';
export { apiClient } from './unified-client';

/* 
 * USAGE EXAMPLES:
 * 
 * ‚úÖ PROFESSIONAL (Individual API Classes):
 * import { AuthenticationApi, AnalyticsApi } from '@/lib/api-client';
 * 
 * ‚úÖ PROFESSIONAL (Unified Client):
 * import { apiClient, isSuccessResponse } from '@/lib/api-client';
 * 
 * ‚úÖ PROFESSIONAL (Specific Models):
 * import { ApiErrorInfo, SessionData } from '@/lib/api-client';
 * 
 * ‚úÖ PROFESSIONAL (Configuration):
 * import { Configuration } from '@/lib/api-client';
 * 
 * ‚ùå AMATEUR (Nested Imports):
 * import { AuthenticationApi } from '@/lib/api-client/apis/authentication-api';
 */
`;
}

/**
 * Fix the OpenAPI generator's garbage index.ts file
 */
function fixApiClientIndex() {
  try {
    console.log('üîß Fixing API client index.ts file...');
    
    // STEP 1: Fix the models index first (exclude legacy garbage)
    fixModelsIndex();
    
    // STEP 2: Fix the legacy api.ts file (remove enum conflicts)
    fixLegacyApiFile();
    
    // STEP 3: Generate professional main index content
    const professionalIndex = generateProfessionalIndex();
    
    // STEP 4: Write the corrected main index
    writeFileSync(INDEX_FILE, professionalIndex, 'utf8');
    
    console.log('‚úÖ API client index.ts fixed!');
    console.log('‚úÖ Professional imports are now available');
    
  } catch (error) {
    console.error('‚ùå Failed to fix API client index:', error);
    throw error;
  }
}

// Run the fix
fixApiClientIndex();/**
 * Fix the auto-generated api.ts file to resolve enum conflicts
 */
function fixApiFileConflicts(): void {
  console.log('üîß Fixing api.ts enum conflicts...');
  
  try {
    const apiFilePath = path.join(API_CLIENT_DIR, 'api.ts');
    
    // Generate a corrected api.ts file with conflict resolution
    const fixedApiContent = `/* tslint:disable */
/* eslint-disable */
/**
 * Domain Flow API
 * A comprehensive API for domain generation, validation, and management operations.
 *
 * The version of the OpenAPI document: 1.0
 * Contact: support@swagger.io
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 * 
 * CONFLICT RESOLUTION: Fixed by post-generation script ${new Date().toISOString()}
 */

export * from './apis/analytics-api';
export * from './apis/authentication-api';

// Export bulk-operations-api first to take precedence for shared enums
export * from './apis/bulk-operations-api';

export * from './apis/campaigns-api';
export * from './apis/database-api';
export * from './apis/domains-api';
export * from './apis/feature-flags-api';
export * from './apis/health-api';
export * from './apis/keyword-extraction-api';
export * from './apis/keyword-sets-api';
export * from './apis/management-api';

// Export monitoring-api with explicit excludes to avoid enum conflicts
export {
  MonitoringApi,
  MonitoringApiAxiosParamCreator,
  MonitoringApiFp,
  MonitoringApiFactory
} from './apis/monitoring-api';

export * from './apis/personas-api';
export * from './apis/proxies-api';
export * from './apis/proxy-pools-api';
export * from './apis/resources-api';
export * from './apis/server-settings-api';
export * from './apis/sse-api';
export * from './apis/validation-api';
export * from './apis/websocket-api';
`;

    writeFileSync(apiFilePath, fixedApiContent, 'utf8');
    console.log('‚úÖ api.ts enum conflicts resolved!');
    
  } catch (error) {
    console.error('‚ùå Failed to fix api.ts conflicts:', error);
    throw error;
  }
}

// Run the fix
fixApiClientIndex();

